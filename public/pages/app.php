<?php
require_once __DIR__ . '/../../includes/session.php';
require_once __DIR__ . '/../../includes/functions.php';
require_once __DIR__ . '/../../config/database.php';

requireLogin();
checkBanStatus();
updatePresence();

$user = getCurrentUser();
$conn = getDB();

// Get selected conversation ID
$selectedConversationID = $_GET['conversation'] ?? null;

// Get user's conversations
$stmt = $conn->prepare("
    SELECT 
        c.conversationID,
        c.createdAt,
        cp.userID as interlocutorID,
        u.username as interlocutorUsername,
        u.profileColor as interlocutorColor,
        us.mode as interlocutorMode,
        us.isOnline as interlocutorOnline,
        us.lastSeenAt as interlocutorLastSeen,
        (SELECT content FROM Message WHERE conversationID = c.conversationID ORDER BY createdAt DESC LIMIT 1) as lastMessage,
        (SELECT createdAt FROM Message WHERE conversationID = c.conversationID ORDER BY createdAt DESC LIMIT 1) as lastMessageTime,
        (SELECT COUNT(*) FROM SafeUser WHERE userID = ? AND safeUserID = cp.userID) as isInSafelist
    FROM Conversation c
    JOIN ConversationParticipant cp ON c.conversationID = cp.conversationID
    JOIN User u ON cp.userID = u.userID
    LEFT JOIN UserStatus us ON cp.userID = us.userID
    WHERE c.conversationID IN (
        SELECT conversationID FROM ConversationParticipant WHERE userID = ?
    )
    AND cp.userID != ?
    ORDER BY lastMessageTime DESC
");
$userID = $user['userID'];
$stmt->bind_param("iii", $userID, $userID, $userID);
$stmt->execute();
$result = $stmt->get_result();
$conversations = [];
while ($row = $result->fetch_assoc()) {
    $conversations[] = $row;
}
$stmt->close();

// Get selected conversation details if any
$selectedConversation = null;
$messages = [];
if ($selectedConversationID) {
    // Verify access
    $stmt = $conn->prepare("
        SELECT COUNT(*) as count 
        FROM ConversationParticipant 
        WHERE conversationID = ? AND userID = ?
    ");
    $stmt->bind_param("ii", $selectedConversationID, $userID);
    $stmt->execute();
    $result = $stmt->get_result();
    $row = $result->fetch_assoc();
    $stmt->close();
    
    if ($row['count'] > 0) {
        // Get interlocutor info
        $stmt = $conn->prepare("
            SELECT 
                u.userID,
                u.username,
                u.profileColor,
                us.mode,
                us.isOnline,
                us.lastSeenAt,
                (SELECT COUNT(*) FROM SafeUser WHERE userID = ? AND safeUserID = u.userID) as isInSafelist
            FROM ConversationParticipant cp
            JOIN User u ON cp.userID = u.userID
            LEFT JOIN UserStatus us ON u.userID = us.userID
            WHERE cp.conversationID = ? AND cp.userID != ?
        ");
        $stmt->bind_param("iii", $userID, $selectedConversationID, $userID);
        $stmt->execute();
        $result = $stmt->get_result();
        $selectedConversation = $result->fetch_assoc();
        $stmt->close();
        
        // Get messages
        $stmt = $conn->prepare("
            SELECT 
                m.*,
                u.username as senderUsername,
                u.profileColor as senderColor
            FROM Message m
            LEFT JOIN User u ON m.senderUserID = u.userID
            WHERE m.conversationID = ?
            ORDER BY m.createdAt ASC
        ");
        $stmt->bind_param("i", $selectedConversationID);
        $stmt->execute();
        $result = $stmt->get_result();
        while ($row = $result->fetch_assoc()) {
            $messages[] = $row;
        }
        $stmt->close();
    }
}

$hasFreshExperience = empty($conversations);
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bip - Anonymous Peer Support</title>
    <link rel="stylesheet" href="../css/app-style.css">
</head>
<body>
    <!-- Top Navigation -->
    <nav class="top-nav">
        <div class="nav-left">
            <svg width="127" height="80" viewBox="0 0 127 80" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g filter="url(#filter0_d_122_28)">
                <mask id="path-1-outside-1_122_28" maskUnits="userSpaceOnUse" x="8" y="14" width="113" height="60" fill="black">
                <rect fill="white" x="8" y="14" width="113" height="60"/>
                <path d="M11.6875 60.1875V20.6875V18.1875C12.4792 18.1042 13.2292 18.0417 13.9375 18C14.6458 17.9583 15.3333 17.9375 16 17.9375C18.7917 17.9375 21.0417 18.25 22.75 18.875C24.5 19.4583 25.8333 20.1875 26.75 21.0625C27.6667 21.9375 28.2708 22.8542 28.5625 23.8125C28.8958 24.7292 29.0625 25.5208 29.0625 26.1875C29.0625 28.3125 28.5417 30.1875 27.5 31.8125C26.5 33.4375 24.9792 34.5625 22.9375 35.1875C29.1875 35.1875 33.7917 36.25 36.75 38.375C39.75 40.5 41.25 43.375 41.25 47C41.25 51.2917 39.25 54.6042 35.25 56.9375C31.25 59.2292 25.1875 60.375 17.0625 60.375C15.3542 60.375 13.5625 60.3125 11.6875 60.1875ZM13.6875 21.8125L14.5625 34.9375C17.6875 34.6458 20.2083 33.7917 22.125 32.375C24.0833 30.9583 25.0625 29.0625 25.0625 26.6875C25.0625 25.1458 24.3542 23.9167 22.9375 23C21.5208 22.0833 19.4167 21.625 16.625 21.625C15.7083 21.625 14.7292 21.6875 13.6875 21.8125ZM14.6875 39.0625L15.6875 55.6875C16.5208 55.7708 17.3125 55.8333 18.0625 55.875C18.8542 55.9167 19.625 55.9375 20.375 55.9375C22.7083 55.9375 24.8958 55.75 26.9375 55.375C28.9792 54.9583 30.75 54.3542 32.25 53.5625C33.75 52.7708 34.9167 51.8125 35.75 50.6875C36.625 49.5625 37.0625 48.2708 37.0625 46.8125C37.0625 45.5208 36.5833 44.375 35.625 43.375C34.7083 42.3333 33.4792 41.4583 31.9375 40.75C30.3958 40.0417 28.6042 39.5208 26.5625 39.1875C24.5625 38.8125 22.5 38.625 20.375 38.625C19.4167 38.625 18.4583 38.6667 17.5 38.75C16.5417 38.8333 15.6042 38.9375 14.6875 39.0625ZM44.5625 46.1875C44.5625 43.8958 44.8958 41.9792 45.5625 40.4375C46.2292 38.8542 47.0625 37.6042 48.0625 36.6875C49.1042 35.7292 50.25 35.0625 51.5 34.6875C52.75 34.2708 53.9583 34.0625 55.125 34.0625C56.7917 34.0625 58.2917 34.3125 59.625 34.8125C60.9583 35.2708 62.0833 36.0625 63 37.1875C63.9583 38.2708 64.6875 39.7292 65.1875 41.5625C65.6875 43.3958 65.9375 45.6458 65.9375 48.3125L48.5625 50C48.6875 51.1667 49 52.1667 49.5 53C50.0417 53.7917 50.7083 54.4375 51.5 54.9375C52.2917 55.4375 53.1458 55.7917 54.0625 56C54.9792 56.2083 55.9167 56.3125 56.875 56.3125C58.4583 56.3125 59.9792 56.0833 61.4375 55.625C62.8958 55.1667 63.9792 54.6042 64.6875 53.9375L65.8125 56.9375C65.5208 57.3542 65.0833 57.7708 64.5 58.1875C63.9167 58.6042 63.2292 58.9583 62.4375 59.25C61.6458 59.5833 60.75 59.8333 59.75 60C58.7917 60.2083 57.7917 60.3125 56.75 60.3125C55.2917 60.3125 53.8333 60.0833 52.375 59.625C50.9167 59.1667 49.6042 58.3958 48.4375 57.3125C47.2708 56.2292 46.3333 54.7917 45.625 53C44.9167 51.1667 44.5625 48.8958 44.5625 46.1875ZM48.1875 46.3125L61.9375 44.8125C61.9375 42.7708 61.3958 41.1458 60.3125 39.9375C59.2292 38.6875 57.4792 38.0625 55.0625 38.0625C53.8958 38.1042 52.875 38.3542 52 38.8125C51.1667 39.2708 50.4583 39.8542 49.875 40.5625C49.2917 41.2292 48.8542 42 48.5625 42.875C48.2708 43.75 48.125 44.6458 48.125 45.5625C48.125 45.8958 48.1458 46.1458 48.1875 46.3125ZM69.8125 46.1875C69.8125 43.8958 70.1458 41.9792 70.8125 40.4375C71.4792 38.8542 72.3125 37.6042 73.3125 36.6875C74.3542 35.7292 75.5 35.0625 76.75 34.6875C78 34.2708 79.2083 34.0625 80.375 34.0625C82.0417 34.0625 83.5417 34.3125 84.875 34.8125C86.2083 35.2708 87.3333 36.0625 88.25 37.1875C89.2083 38.2708 89.9375 39.7292 90.4375 41.5625C90.9375 43.3958 91.1875 45.6458 91.1875 48.3125L73.8125 50C73.9375 51.1667 74.25 52.1667 74.75 53C75.2917 53.7917 75.9583 54.4375 76.75 54.9375C77.5417 55.4375 78.3958 55.7917 79.3125 56C80.2292 56.2083 81.1667 56.3125 82.125 56.3125C83.7083 56.3125 85.2292 56.0833 86.6875 55.625C88.1458 55.1667 89.2292 54.6042 89.9375 53.9375L91.0625 56.9375C90.7708 57.3542 90.3333 57.7708 89.75 58.1875C89.1667 58.6042 88.4792 58.9583 87.6875 59.25C86.8958 59.5833 86 59.8333 85 60C84.0417 60.2083 83.0417 60.3125 82 60.3125C80.5417 60.3125 79.0833 60.0833 77.625 59.625C76.1667 59.1667 74.8542 58.3958 73.6875 57.3125C72.5208 56.2292 71.5833 54.7917 70.875 53C70.1667 51.1667 69.8125 48.8958 69.8125 46.1875ZM73.4375 46.3125L87.1875 44.8125C87.1875 42.7708 86.6458 41.1458 85.5625 39.9375C84.4792 38.6875 82.7292 38.0625 80.3125 38.0625C79.1458 38.1042 78.125 38.3542 77.25 38.8125C76.4167 39.2708 75.7083 39.8542 75.125 40.5625C74.5417 41.2292 74.1042 42 73.8125 42.875C73.5208 43.75 73.375 44.6458 73.375 45.5625C73.375 45.8958 73.3958 46.1458 73.4375 46.3125ZM117.312 44.1875V45.5C117.312 47.875 116.958 49.8542 116.25 51.4375C115.542 53.0208 114.646 54.2917 113.562 55.25C112.521 56.1667 111.354 56.8125 110.062 57.1875C108.771 57.5625 107.542 57.75 106.375 57.75C105.042 57.75 103.792 57.5833 102.625 57.25C101.5 56.9167 100.646 56.5208 100.062 56.0625L100.562 70.0625L96.6875 70.4375V36.4375L97.0625 33.5625C100.146 32.8542 102.812 32.5 105.062 32.5C108.938 32.5 111.896 33.4792 113.938 35.4375C116.021 37.3542 117.146 40.2708 117.312 44.1875ZM99.4375 37.9375L99.6875 50.3125C99.7292 50.5208 99.9375 50.7708 100.312 51.0625C100.729 51.3542 101.25 51.6458 101.875 51.9375C102.542 52.1875 103.271 52.4167 104.062 52.625C104.854 52.7917 105.667 52.875 106.5 52.875C107.292 52.875 108.083 52.75 108.875 52.5C109.708 52.2083 110.438 51.7292 111.062 51.0625C111.729 50.3958 112.271 49.5 112.688 48.375C113.104 47.25 113.312 45.8542 113.312 44.1875C113.312 42.8958 113.062 41.7708 112.562 40.8125C112.104 39.8125 111.458 39 110.625 38.375C109.833 37.7083 108.917 37.2292 107.875 36.9375C106.875 36.6042 105.833 36.4375 104.75 36.4375C103.792 36.4375 102.854 36.5625 101.938 36.8125C101.021 37.0625 100.188 37.4375 99.4375 37.9375Z"/>
                </mask>
                <path d="M11.6875 60.1875V20.6875V18.1875C12.4792 18.1042 13.2292 18.0417 13.9375 18C14.6458 17.9583 15.3333 17.9375 16 17.9375C18.7917 17.9375 21.0417 18.25 22.75 18.875C24.5 19.4583 25.8333 20.1875 26.75 21.0625C27.6667 21.9375 28.2708 22.8542 28.5625 23.8125C28.8958 24.7292 29.0625 25.5208 29.0625 26.1875C29.0625 28.3125 28.5417 30.1875 27.5 31.8125C26.5 33.4375 24.9792 34.5625 22.9375 35.1875C29.1875 35.1875 33.7917 36.25 36.75 38.375C39.75 40.5 41.25 43.375 41.25 47C41.25 51.2917 39.25 54.6042 35.25 56.9375C31.25 59.2292 25.1875 60.375 17.0625 60.375C15.3542 60.375 13.5625 60.3125 11.6875 60.1875ZM13.6875 21.8125L14.5625 34.9375C17.6875 34.6458 20.2083 33.7917 22.125 32.375C24.0833 30.9583 25.0625 29.0625 25.0625 26.6875C25.0625 25.1458 24.3542 23.9167 22.9375 23C21.5208 22.0833 19.4167 21.625 16.625 21.625C15.7083 21.625 14.7292 21.6875 13.6875 21.8125ZM14.6875 39.0625L15.6875 55.6875C16.5208 55.7708 17.3125 55.8333 18.0625 55.875C18.8542 55.9167 19.625 55.9375 20.375 55.9375C22.7083 55.9375 24.8958 55.75 26.9375 55.375C28.9792 54.9583 30.75 54.3542 32.25 53.5625C33.75 52.7708 34.9167 51.8125 35.75 50.6875C36.625 49.5625 37.0625 48.2708 37.0625 46.8125C37.0625 45.5208 36.5833 44.375 35.625 43.375C34.7083 42.3333 33.4792 41.4583 31.9375 40.75C30.3958 40.0417 28.6042 39.5208 26.5625 39.1875C24.5625 38.8125 22.5 38.625 20.375 38.625C19.4167 38.625 18.4583 38.6667 17.5 38.75C16.5417 38.8333 15.6042 38.9375 14.6875 39.0625ZM44.5625 46.1875C44.5625 43.8958 44.8958 41.9792 45.5625 40.4375C46.2292 38.8542 47.0625 37.6042 48.0625 36.6875C49.1042 35.7292 50.25 35.0625 51.5 34.6875C52.75 34.2708 53.9583 34.0625 55.125 34.0625C56.7917 34.0625 58.2917 34.3125 59.625 34.8125C60.9583 35.2708 62.0833 36.0625 63 37.1875C63.9583 38.2708 64.6875 39.7292 65.1875 41.5625C65.6875 43.3958 65.9375 45.6458 65.9375 48.3125L48.5625 50C48.6875 51.1667 49 52.1667 49.5 53C50.0417 53.7917 50.7083 54.4375 51.5 54.9375C52.2917 55.4375 53.1458 55.7917 54.0625 56C54.9792 56.2083 55.9167 56.3125 56.875 56.3125C58.4583 56.3125 59.9792 56.0833 61.4375 55.625C62.8958 55.1667 63.9792 54.6042 64.6875 53.9375L65.8125 56.9375C65.5208 57.3542 65.0833 57.7708 64.5 58.1875C63.9167 58.6042 63.2292 58.9583 62.4375 59.25C61.6458 59.5833 60.75 59.8333 59.75 60C58.7917 60.2083 57.7917 60.3125 56.75 60.3125C55.2917 60.3125 53.8333 60.0833 52.375 59.625C50.9167 59.1667 49.6042 58.3958 48.4375 57.3125C47.2708 56.2292 46.3333 54.7917 45.625 53C44.9167 51.1667 44.5625 48.8958 44.5625 46.1875ZM48.1875 46.3125L61.9375 44.8125C61.9375 42.7708 61.3958 41.1458 60.3125 39.9375C59.2292 38.6875 57.4792 38.0625 55.0625 38.0625C53.8958 38.1042 52.875 38.3542 52 38.8125C51.1667 39.2708 50.4583 39.8542 49.875 40.5625C49.2917 41.2292 48.8542 42 48.5625 42.875C48.2708 43.75 48.125 44.6458 48.125 45.5625C48.125 45.8958 48.1458 46.1458 48.1875 46.3125ZM69.8125 46.1875C69.8125 43.8958 70.1458 41.9792 70.8125 40.4375C71.4792 38.8542 72.3125 37.6042 73.3125 36.6875C74.3542 35.7292 75.5 35.0625 76.75 34.6875C78 34.2708 79.2083 34.0625 80.375 34.0625C82.0417 34.0625 83.5417 34.3125 84.875 34.8125C86.2083 35.2708 87.3333 36.0625 88.25 37.1875C89.2083 38.2708 89.9375 39.7292 90.4375 41.5625C90.9375 43.3958 91.1875 45.6458 91.1875 48.3125L73.8125 50C73.9375 51.1667 74.25 52.1667 74.75 53C75.2917 53.7917 75.9583 54.4375 76.75 54.9375C77.5417 55.4375 78.3958 55.7917 79.3125 56C80.2292 56.2083 81.1667 56.3125 82.125 56.3125C83.7083 56.3125 85.2292 56.0833 86.6875 55.625C88.1458 55.1667 89.2292 54.6042 89.9375 53.9375L91.0625 56.9375C90.7708 57.3542 90.3333 57.7708 89.75 58.1875C89.1667 58.6042 88.4792 58.9583 87.6875 59.25C86.8958 59.5833 86 59.8333 85 60C84.0417 60.2083 83.0417 60.3125 82 60.3125C80.5417 60.3125 79.0833 60.0833 77.625 59.625C76.1667 59.1667 74.8542 58.3958 73.6875 57.3125C72.5208 56.2292 71.5833 54.7917 70.875 53C70.1667 51.1667 69.8125 48.8958 69.8125 46.1875ZM73.4375 46.3125L87.1875 44.8125C87.1875 42.7708 86.6458 41.1458 85.5625 39.9375C84.4792 38.6875 82.7292 38.0625 80.3125 38.0625C79.1458 38.1042 78.125 38.3542 77.25 38.8125C76.4167 39.2708 75.7083 39.8542 75.125 40.5625C74.5417 41.2292 74.1042 42 73.8125 42.875C73.5208 43.75 73.375 44.6458 73.375 45.5625C73.375 45.8958 73.3958 46.1458 73.4375 46.3125ZM117.312 44.1875V45.5C117.312 47.875 116.958 49.8542 116.25 51.4375C115.542 53.0208 114.646 54.2917 113.562 55.25C112.521 56.1667 111.354 56.8125 110.062 57.1875C108.771 57.5625 107.542 57.75 106.375 57.75C105.042 57.75 103.792 57.5833 102.625 57.25C101.5 56.9167 100.646 56.5208 100.062 56.0625L100.562 70.0625L96.6875 70.4375V36.4375L97.0625 33.5625C100.146 32.8542 102.812 32.5 105.062 32.5C108.938 32.5 111.896 33.4792 113.938 35.4375C116.021 37.3542 117.146 40.2708 117.312 44.1875ZM99.4375 37.9375L99.6875 50.3125C99.7292 50.5208 99.9375 50.7708 100.312 51.0625C100.729 51.3542 101.25 51.6458 101.875 51.9375C102.542 52.1875 103.271 52.4167 104.062 52.625C104.854 52.7917 105.667 52.875 106.5 52.875C107.292 52.875 108.083 52.75 108.875 52.5C109.708 52.2083 110.438 51.7292 111.062 51.0625C111.729 50.3958 112.271 49.5 112.688 48.375C113.104 47.25 113.312 45.8542 113.312 44.1875C113.312 42.8958 113.062 41.7708 112.562 40.8125C112.104 39.8125 111.458 39 110.625 38.375C109.833 37.7083 108.917 37.2292 107.875 36.9375C106.875 36.6042 105.833 36.4375 104.75 36.4375C103.792 36.4375 102.854 36.5625 101.938 36.8125C101.021 37.0625 100.188 37.4375 99.4375 37.9375Z" fill="#E2DFB0"/>
                <path d="M11.6875 60.1875H8.6875V62.9942L11.4879 63.1809L11.6875 60.1875ZM11.6875 18.1875L11.3734 15.204L8.6875 15.4867V18.1875H11.6875ZM22.75 18.875L21.7193 21.6924L21.7601 21.7073L21.8013 21.721L22.75 18.875ZM28.5625 23.8125L25.6925 24.686L25.7158 24.7625L25.7431 24.8377L28.5625 23.8125ZM27.5 31.8125L24.9744 30.1935L24.9595 30.2167L24.945 30.2402L27.5 31.8125ZM22.9375 35.1875L22.0594 32.3189L22.9375 38.1875V35.1875ZM36.75 38.375L34.9998 40.8116L35.0079 40.8173L35.0159 40.8231L36.75 38.375ZM35.25 56.9375L36.7413 59.5406L36.7515 59.5347L36.7616 59.5288L35.25 56.9375ZM13.6875 21.8125L13.3301 18.8339L10.5049 19.1729L10.6941 22.0121L13.6875 21.8125ZM14.5625 34.9375L11.5691 35.1371L11.7741 38.2108L14.8413 37.9245L14.5625 34.9375ZM22.125 32.375L20.3666 29.9443L20.3542 29.9533L20.3418 29.9625L22.125 32.375ZM14.6875 39.0625L14.2822 36.09L11.5259 36.4659L11.6929 39.2426L14.6875 39.0625ZM15.6875 55.6875L12.6929 55.8676L12.8463 58.4183L15.389 58.6726L15.6875 55.6875ZM18.0625 55.875L17.8961 58.8704L17.9048 58.8709L18.0625 55.875ZM26.9375 55.375L27.4795 58.3256L27.5085 58.3203L27.5374 58.3144L26.9375 55.375ZM35.75 50.6875L33.3819 48.8457L33.3603 48.8735L33.3393 48.9018L35.75 50.6875ZM35.625 43.375L33.3729 45.3569L33.415 45.4047L33.459 45.4507L35.625 43.375ZM26.5625 39.1875L26.0096 42.1361L26.0443 42.1426L26.0791 42.1483L26.5625 39.1875ZM11.6875 60.1875H14.6875V20.6875H11.6875H8.6875V60.1875H11.6875ZM11.6875 20.6875H14.6875V18.1875H11.6875H8.6875V20.6875H11.6875ZM11.6875 18.1875L12.0016 21.171C12.7528 21.0919 13.4565 21.0335 14.1137 20.9948L13.9375 18L13.7613 15.0052C13.0018 15.0499 12.2056 15.1164 11.3734 15.204L11.6875 18.1875ZM13.9375 18L14.1137 20.9948C14.7671 20.9564 15.3957 20.9375 16 20.9375V17.9375V14.9375C15.271 14.9375 14.5246 14.9603 13.7613 15.0052L13.9375 18ZM16 17.9375V20.9375C18.6078 20.9375 20.4686 21.2348 21.7193 21.6924L22.75 18.875L23.7807 16.0576C21.6147 15.2652 18.9756 14.9375 16 14.9375V17.9375ZM22.75 18.875L21.8013 21.721C23.3081 22.2233 24.1934 22.7694 24.6786 23.2326L26.75 21.0625L28.8214 18.8924C27.4733 17.6056 25.6919 16.6933 23.6987 16.029L22.75 18.875ZM26.75 21.0625L24.6786 23.2326C25.3191 23.844 25.5859 24.3356 25.6925 24.686L28.5625 23.8125L31.4325 22.939C30.9558 21.3727 30.0142 20.031 28.8214 18.8924L26.75 21.0625ZM28.5625 23.8125L25.7431 24.8377C26.0072 25.564 26.0625 25.9923 26.0625 26.1875H29.0625H32.0625C32.0625 25.0494 31.7844 23.8943 31.3819 22.7873L28.5625 23.8125ZM29.0625 26.1875H26.0625C26.0625 27.7986 25.6754 29.0999 24.9744 30.1935L27.5 31.8125L30.0256 33.4315C31.4079 31.2751 32.0625 28.8264 32.0625 26.1875H29.0625ZM27.5 31.8125L24.945 30.2402C24.3738 31.1684 23.4921 31.8803 22.0594 32.3189L22.9375 35.1875L23.8156 38.0561C26.4662 37.2447 28.6262 35.7066 30.055 33.3848L27.5 31.8125ZM22.9375 35.1875V38.1875C28.9616 38.1875 32.8021 39.2329 34.9998 40.8116L36.75 38.375L38.5002 35.9384C34.7812 33.2671 29.4134 32.1875 22.9375 32.1875V35.1875ZM36.75 38.375L35.0159 40.8231C37.2353 42.3951 38.25 44.3644 38.25 47H41.25H44.25C44.25 42.3856 42.2647 38.6049 38.4841 35.9269L36.75 38.375ZM41.25 47H38.25C38.25 50.1259 36.9054 52.4988 33.7384 54.3462L35.25 56.9375L36.7616 59.5288C41.5946 56.7096 44.25 52.4574 44.25 47H41.25ZM35.25 56.9375L33.7587 54.3344C30.4395 56.236 25.0094 57.375 17.0625 57.375V60.375V63.375C25.3656 63.375 32.0605 62.2223 36.7413 59.5406L35.25 56.9375ZM17.0625 60.375V57.375C15.4269 57.375 13.7021 57.3151 11.8871 57.1941L11.6875 60.1875L11.4879 63.1809C13.4229 63.3099 15.2814 63.375 17.0625 63.375V60.375ZM13.6875 21.8125L10.6941 22.0121L11.5691 35.1371L14.5625 34.9375L17.5559 34.7379L16.6809 21.6129L13.6875 21.8125ZM14.5625 34.9375L14.8413 37.9245C18.3426 37.5977 21.4333 36.6168 23.9082 34.7875L22.125 32.375L20.3418 29.9625C18.9833 30.9666 17.0324 31.6939 14.2837 31.9505L14.5625 34.9375ZM22.125 32.375L23.8834 34.8057C26.6052 32.8367 28.0625 30.045 28.0625 26.6875H25.0625H22.0625C22.0625 28.08 21.5615 29.0799 20.3666 29.9443L22.125 32.375ZM25.0625 26.6875H28.0625C28.0625 24.019 26.7424 21.8887 24.5673 20.4813L22.9375 23L21.3077 25.5187C21.966 25.9446 22.0625 26.2727 22.0625 26.6875H25.0625ZM22.9375 23L24.5673 20.4813C22.4421 19.1062 19.6548 18.625 16.625 18.625V21.625V24.625C19.1785 24.625 20.5996 25.0605 21.3077 25.5187L22.9375 23ZM16.625 21.625V18.625C15.5733 18.625 14.4738 18.6966 13.3301 18.8339L13.6875 21.8125L14.0449 24.7911C14.9846 24.6784 15.8434 24.625 16.625 24.625V21.625ZM14.6875 39.0625L11.6929 39.2426L12.6929 55.8676L15.6875 55.6875L18.6821 55.5074L17.6821 38.8824L14.6875 39.0625ZM15.6875 55.6875L15.389 58.6726C16.2614 58.7598 17.0973 58.826 17.8961 58.8704L18.0625 55.875L18.2289 52.8796C17.5277 52.8407 16.7803 52.7818 15.986 52.7024L15.6875 55.6875ZM18.0625 55.875L17.9048 58.8709C18.7461 58.9151 19.5695 58.9375 20.375 58.9375V55.9375V52.9375C19.6805 52.9375 18.9623 52.9182 18.2202 52.8791L18.0625 55.875ZM20.375 55.9375V58.9375C22.8681 58.9375 25.2386 58.7372 27.4795 58.3256L26.9375 55.375L26.3955 52.4244C24.5531 52.7628 22.5485 52.9375 20.375 52.9375V55.9375ZM26.9375 55.375L27.5374 58.3144C29.797 57.8533 31.8487 57.1665 33.6503 56.2157L32.25 53.5625L30.8497 50.9093C29.6513 51.5418 28.1613 52.0634 26.3376 52.4356L26.9375 55.375ZM32.25 53.5625L33.6503 56.2157C35.4651 55.2578 37.0092 54.0277 38.1607 52.4732L35.75 50.6875L33.3393 48.9018C32.8241 49.5973 32.0349 50.2838 30.8497 50.9093L32.25 53.5625ZM35.75 50.6875L38.1181 52.5293C39.4128 50.8646 40.0625 48.9212 40.0625 46.8125H37.0625H34.0625C34.0625 47.6205 33.8372 48.2604 33.3819 48.8457L35.75 50.6875ZM37.0625 46.8125H40.0625C40.0625 44.6879 39.242 42.8134 37.791 41.2993L35.625 43.375L33.459 45.4507C33.9247 45.9366 34.0625 46.3538 34.0625 46.8125H37.0625ZM35.625 43.375L37.8771 41.3931C36.6284 39.9741 35.0303 38.8695 33.19 38.024L31.9375 40.75L30.685 43.476C31.928 44.0472 32.7882 44.6925 33.3729 45.3569L35.625 43.375ZM31.9375 40.75L33.19 38.024C31.3571 37.1818 29.2974 36.5943 27.0459 36.2267L26.5625 39.1875L26.0791 42.1483C27.9109 42.4474 29.4346 42.9015 30.685 43.476L31.9375 40.75ZM26.5625 39.1875L27.1154 36.2389C24.9252 35.8282 22.6773 35.625 20.375 35.625V38.625V41.625C22.3227 41.625 24.1998 41.7968 26.0096 42.1361L26.5625 39.1875ZM20.375 38.625V35.625C19.3296 35.625 18.2845 35.6705 17.2401 35.7613L17.5 38.75L17.7599 41.7387C18.6321 41.6629 19.5037 41.625 20.375 41.625V38.625ZM17.5 38.75L17.2401 35.7613C16.2351 35.8487 15.249 35.9582 14.2822 36.09L14.6875 39.0625L15.0928 42.035C15.9593 41.9168 16.8482 41.818 17.7599 41.7387L17.5 38.75ZM45.5625 40.4375L48.3161 41.6282L48.3218 41.615L48.3274 41.6017L45.5625 40.4375ZM48.0625 36.6875L50.0897 38.899L50.0937 38.8953L48.0625 36.6875ZM51.5 34.6875L52.362 37.561L52.4056 37.5479L52.4487 37.5335L51.5 34.6875ZM59.625 34.8125L58.5716 37.6215L58.6105 37.6361L58.6498 37.6496L59.625 34.8125ZM63 37.1875L60.6743 39.0825L60.7127 39.1297L60.753 39.1752L63 37.1875ZM65.9375 48.3125L66.2275 51.2985L68.9375 51.0352V48.3125H65.9375ZM48.5625 50L48.2725 47.014L45.2568 47.3069L45.5796 50.3196L48.5625 50ZM49.5 53L46.9275 54.5435L46.9736 54.6202L47.0241 54.6941L49.5 53ZM64.6875 53.9375L67.4965 52.8841L65.9138 48.6636L62.6314 51.7529L64.6875 53.9375ZM65.8125 56.9375L68.2702 58.6579L69.1763 57.3635L68.6215 55.8841L65.8125 56.9375ZM62.4375 59.25L61.4004 56.435L61.3363 56.4586L61.2733 56.4851L62.4375 59.25ZM59.75 60L59.2568 57.0408L59.1844 57.0529L59.1127 57.0685L59.75 60ZM52.375 59.625L51.4755 62.487L52.375 59.625ZM45.625 53L42.8266 54.0812L42.8308 54.0921L42.8351 54.103L45.625 53ZM48.1875 46.3125L45.2771 47.0401L45.9117 49.5786L48.5128 49.2948L48.1875 46.3125ZM61.9375 44.8125L62.2628 47.7948L64.9375 47.503V44.8125H61.9375ZM60.3125 39.9375L58.0454 41.9023L58.062 41.9214L58.0788 41.9401L60.3125 39.9375ZM55.0625 38.0625V35.0625H55.0089L54.9554 35.0644L55.0625 38.0625ZM52 38.8125L50.608 36.155L50.581 36.1692L50.5542 36.1839L52 38.8125ZM49.875 40.5625L52.1327 42.538L52.1623 42.5043L52.1908 42.4696L49.875 40.5625ZM44.5625 46.1875H47.5625C47.5625 44.1652 47.8597 42.6837 48.3161 41.6282L45.5625 40.4375L42.8089 39.2468C41.932 41.2747 41.5625 43.6265 41.5625 46.1875H44.5625ZM45.5625 40.4375L48.3274 41.6017C48.8696 40.3139 49.4811 39.4568 50.0897 38.899L48.0625 36.6875L46.0353 34.476C44.6439 35.7515 43.5887 37.3945 42.7976 39.2733L45.5625 40.4375ZM48.0625 36.6875L50.0937 38.8953C50.8298 38.218 51.5831 37.7947 52.362 37.561L51.5 34.6875L50.638 31.814C48.9169 32.3303 47.3785 33.2403 46.0313 34.4797L48.0625 36.6875ZM51.5 34.6875L52.4487 37.5335C53.4318 37.2058 54.3195 37.0625 55.125 37.0625V34.0625V31.0625C53.5971 31.0625 52.0682 31.3358 50.5513 31.8415L51.5 34.6875ZM55.125 34.0625V37.0625C56.4921 37.0625 57.6272 37.2673 58.5716 37.6215L59.625 34.8125L60.6784 32.0035C58.9561 31.3577 57.0913 31.0625 55.125 31.0625V34.0625ZM59.625 34.8125L58.6498 37.6496C59.4378 37.9205 60.1002 38.378 60.6743 39.0825L63 37.1875L65.3257 35.2925C64.0664 33.747 62.4789 32.6212 60.6002 31.9754L59.625 34.8125ZM63 37.1875L60.753 39.1752C61.3264 39.8234 61.8778 40.8286 62.2932 42.3519L65.1875 41.5625L68.0818 40.7731C67.4972 38.6297 66.5903 36.7183 65.247 35.1998L63 37.1875ZM65.1875 41.5625L62.2932 42.3519C62.7012 43.8478 62.9375 45.8142 62.9375 48.3125H65.9375H68.9375C68.9375 45.4775 68.6738 42.9439 68.0818 40.7731L65.1875 41.5625ZM65.9375 48.3125L65.6475 45.3265L48.2725 47.014L48.5625 50L48.8525 52.986L66.2275 51.2985L65.9375 48.3125ZM48.5625 50L45.5796 50.3196C45.7415 51.831 46.162 53.2675 46.9275 54.5435L49.5 53L52.0725 51.4565C51.838 51.0658 51.6335 50.5024 51.5454 49.6804L48.5625 50ZM49.5 53L47.0241 54.6941C47.7908 55.8147 48.7521 56.7502 49.898 57.474L51.5 54.9375L53.102 52.401C52.6646 52.1248 52.2925 51.7687 51.9759 51.3059L49.5 53ZM51.5 54.9375L49.898 57.474C50.9789 58.1566 52.1501 58.6419 53.3976 58.9254L54.0625 56L54.7274 53.0746C54.1415 52.9415 53.6045 52.7184 53.102 52.401L51.5 54.9375ZM54.0625 56L53.3976 58.9254C54.5367 59.1843 55.6973 59.3125 56.875 59.3125V56.3125V53.3125C56.136 53.3125 55.4217 53.2324 54.7274 53.0746L54.0625 56ZM56.875 56.3125V59.3125C58.7524 59.3125 60.5773 59.04 62.337 58.487L61.4375 55.625L60.538 52.763C59.3811 53.1266 58.1642 53.3125 56.875 53.3125V56.3125ZM61.4375 55.625L62.337 58.487C64.0057 57.9625 65.5706 57.2261 66.7436 56.1221L64.6875 53.9375L62.6314 51.7529C62.3877 51.9822 61.7859 52.3708 60.538 52.763L61.4375 55.625ZM64.6875 53.9375L61.8785 54.9909L63.0035 57.9909L65.8125 56.9375L68.6215 55.8841L67.4965 52.8841L64.6875 53.9375ZM65.8125 56.9375L63.3548 55.2171C63.3205 55.2661 63.1668 55.453 62.7563 55.7463L64.5 58.1875L66.2437 60.6287C66.9998 60.0886 67.7211 59.4423 68.2702 58.6579L65.8125 56.9375ZM64.5 58.1875L62.7563 55.7463C62.4252 55.9828 61.9839 56.22 61.4004 56.435L62.4375 59.25L63.4746 62.065C64.4744 61.6967 65.4082 61.2255 66.2437 60.6287L64.5 58.1875ZM62.4375 59.25L61.2733 56.4851C60.7315 56.7132 60.0664 56.9059 59.2568 57.0408L59.75 60L60.2432 62.9592C61.4336 62.7608 62.5602 62.4534 63.6017 62.0149L62.4375 59.25ZM59.75 60L59.1127 57.0685C58.3763 57.2286 57.5906 57.3125 56.75 57.3125V60.3125V63.3125C57.9927 63.3125 59.207 63.1881 60.3873 62.9315L59.75 60ZM56.75 60.3125V57.3125C55.6112 57.3125 54.4559 57.1343 53.2745 56.763L52.375 59.625L51.4755 62.487C53.2108 63.0324 54.9721 63.3125 56.75 63.3125V60.3125ZM52.375 59.625L53.2745 56.763C52.2591 56.4439 51.3328 55.9071 50.4789 55.1141L48.4375 57.3125L46.3961 59.5109C47.8755 60.8846 49.5742 61.8894 51.4755 62.487L52.375 59.625ZM48.4375 57.3125L50.4789 55.1141C49.702 54.3928 48.9926 53.3584 48.4149 51.897L45.625 53L42.8351 54.103C43.674 56.225 44.8397 58.0656 46.3961 59.5109L48.4375 57.3125ZM45.625 53L48.4234 51.9188C47.8883 50.5339 47.5625 48.6562 47.5625 46.1875H44.5625H41.5625C41.5625 49.1354 41.945 51.7995 42.8266 54.0812L45.625 53ZM48.1875 46.3125L48.5128 49.2948L62.2628 47.7948L61.9375 44.8125L61.6122 41.8302L47.8622 43.3302L48.1875 46.3125ZM61.9375 44.8125H64.9375C64.9375 42.2295 64.2407 39.8249 62.5462 37.9349L60.3125 39.9375L58.0788 41.9401C58.5509 42.4668 58.9375 43.3122 58.9375 44.8125H61.9375ZM60.3125 39.9375L62.5796 37.9727C60.7039 35.8085 57.9394 35.0625 55.0625 35.0625V38.0625V41.0625C57.0189 41.0625 57.7544 41.5665 58.0454 41.9023L60.3125 39.9375ZM55.0625 38.0625L54.9554 35.0644C53.4212 35.1192 51.9464 35.4539 50.608 36.155L52 38.8125L53.392 41.47C53.8036 41.2544 54.3705 41.0891 55.1696 41.0606L55.0625 38.0625ZM52 38.8125L50.5542 36.1839C49.4002 36.8186 48.393 37.6429 47.5592 38.6554L49.875 40.5625L52.1908 42.4696C52.5236 42.0654 52.9332 41.7231 53.4458 41.4411L52 38.8125ZM49.875 40.5625L47.6173 38.587C46.7608 39.5658 46.1288 40.6892 45.7165 41.9263L48.5625 42.875L51.4085 43.8237C51.5795 43.3108 51.8225 42.8925 52.1327 42.538L49.875 40.5625ZM48.5625 42.875L45.7165 41.9263C45.3235 43.1053 45.125 44.3214 45.125 45.5625H48.125H51.125C51.125 44.9703 51.2182 44.3947 51.4085 43.8237L48.5625 42.875ZM48.125 45.5625H45.125C45.125 45.9572 45.1436 46.5063 45.2771 47.0401L48.1875 46.3125L51.0979 45.5849C51.1069 45.6207 51.1133 45.6506 51.1177 45.6735C51.1222 45.6965 51.1251 45.7145 51.127 45.7269C51.1288 45.7393 51.1298 45.7475 51.1302 45.7511C51.1306 45.7547 51.1306 45.7548 51.1303 45.7509C51.1296 45.7425 51.1282 45.7227 51.127 45.6898C51.1258 45.6571 51.125 45.615 51.125 45.5625H48.125ZM70.8125 40.4375L73.5661 41.6282L73.5718 41.615L73.5774 41.6017L70.8125 40.4375ZM73.3125 36.6875L75.3397 38.899L75.3437 38.8953L73.3125 36.6875ZM76.75 34.6875L77.612 37.561L77.6556 37.5479L77.6987 37.5335L76.75 34.6875ZM84.875 34.8125L83.8216 37.6215L83.8605 37.6361L83.8998 37.6496L84.875 34.8125ZM88.25 37.1875L85.9243 39.0825L85.9627 39.1297L86.003 39.1752L88.25 37.1875ZM91.1875 48.3125L91.4775 51.2985L94.1875 51.0352V48.3125H91.1875ZM73.8125 50L73.5225 47.014L70.5068 47.3069L70.8296 50.3196L73.8125 50ZM74.75 53L72.1775 54.5435L72.2236 54.6202L72.2741 54.6941L74.75 53ZM89.9375 53.9375L92.7465 52.8841L91.1638 48.6636L87.8814 51.7529L89.9375 53.9375ZM91.0625 56.9375L93.5202 58.6579L94.4263 57.3635L93.8715 55.8841L91.0625 56.9375ZM87.6875 59.25L86.6504 56.435L86.5863 56.4586L86.5233 56.4851L87.6875 59.25ZM85 60L84.5068 57.0408L84.4344 57.0529L84.3627 57.0685L85 60ZM77.625 59.625L76.7255 62.487L77.625 59.625ZM70.875 53L68.0766 54.0812L68.0808 54.0921L68.0851 54.103L70.875 53ZM73.4375 46.3125L70.5271 47.0401L71.1617 49.5786L73.7628 49.2948L73.4375 46.3125ZM87.1875 44.8125L87.5128 47.7948L90.1875 47.503V44.8125H87.1875ZM85.5625 39.9375L83.2954 41.9023L83.312 41.9214L83.3288 41.9401L85.5625 39.9375ZM80.3125 38.0625V35.0625H80.2589L80.2054 35.0644L80.3125 38.0625ZM77.25 38.8125L75.858 36.155L75.831 36.1692L75.8042 36.1839L77.25 38.8125ZM75.125 40.5625L77.3827 42.538L77.4123 42.5043L77.4408 42.4696L75.125 40.5625ZM69.8125 46.1875H72.8125C72.8125 44.1652 73.1097 42.6837 73.5661 41.6282L70.8125 40.4375L68.0589 39.2468C67.182 41.2747 66.8125 43.6265 66.8125 46.1875H69.8125ZM70.8125 40.4375L73.5774 41.6017C74.1196 40.3139 74.7311 39.4568 75.3397 38.899L73.3125 36.6875L71.2853 34.476C69.8939 35.7515 68.8387 37.3945 68.0476 39.2733L70.8125 40.4375ZM73.3125 36.6875L75.3437 38.8953C76.0798 38.218 76.8331 37.7947 77.612 37.561L76.75 34.6875L75.888 31.814C74.1669 32.3303 72.6285 33.2403 71.2813 34.4797L73.3125 36.6875ZM76.75 34.6875L77.6987 37.5335C78.6818 37.2058 79.5695 37.0625 80.375 37.0625V34.0625V31.0625C78.8471 31.0625 77.3182 31.3358 75.8013 31.8415L76.75 34.6875ZM80.375 34.0625V37.0625C81.7421 37.0625 82.8772 37.2673 83.8216 37.6215L84.875 34.8125L85.9284 32.0035C84.2061 31.3577 82.3413 31.0625 80.375 31.0625V34.0625ZM84.875 34.8125L83.8998 37.6496C84.6878 37.9205 85.3502 38.378 85.9243 39.0825L88.25 37.1875L90.5757 35.2925C89.3164 33.747 87.7289 32.6212 85.8502 31.9754L84.875 34.8125ZM88.25 37.1875L86.003 39.1752C86.5764 39.8234 87.1278 40.8286 87.5432 42.3519L90.4375 41.5625L93.3318 40.7731C92.7472 38.6297 91.8403 36.7183 90.497 35.1998L88.25 37.1875ZM90.4375 41.5625L87.5432 42.3519C87.9512 43.8478 88.1875 45.8142 88.1875 48.3125H91.1875H94.1875C94.1875 45.4775 93.9238 42.9439 93.3318 40.7731L90.4375 41.5625ZM91.1875 48.3125L90.8975 45.3265L73.5225 47.014L73.8125 50L74.1025 52.986L91.4775 51.2985L91.1875 48.3125ZM73.8125 50L70.8296 50.3196C70.9915 51.831 71.412 53.2675 72.1775 54.5435L74.75 53L77.3225 51.4565C77.088 51.0658 76.8835 50.5024 76.7954 49.6804L73.8125 50ZM74.75 53L72.2741 54.6941C73.0408 55.8147 74.0021 56.7502 75.148 57.474L76.75 54.9375L78.352 52.401C77.9146 52.1248 77.5425 51.7687 77.2259 51.3059L74.75 53ZM76.75 54.9375L75.148 57.474C76.2289 58.1566 77.4001 58.6419 78.6476 58.9254L79.3125 56L79.9774 53.0746C79.3915 52.9415 78.8545 52.7184 78.352 52.401L76.75 54.9375ZM79.3125 56L78.6476 58.9254C79.7867 59.1843 80.9473 59.3125 82.125 59.3125V56.3125V53.3125C81.386 53.3125 80.6717 53.2324 79.9774 53.0746L79.3125 56ZM82.125 56.3125V59.3125C84.0024 59.3125 85.8273 59.04 87.587 58.487L86.6875 55.625L85.788 52.763C84.6311 53.1266 83.4142 53.3125 82.125 53.3125V56.3125ZM86.6875 55.625L87.587 58.487C89.2557 57.9625 90.8206 57.2261 91.9936 56.1221L89.9375 53.9375L87.8814 51.7529C87.6377 51.9822 87.0359 52.3708 85.788 52.763L86.6875 55.625ZM89.9375 53.9375L87.1285 54.9909L88.2535 57.9909L91.0625 56.9375L93.8715 55.8841L92.7465 52.8841L89.9375 53.9375ZM91.0625 56.9375L88.6048 55.2171C88.5705 55.2661 88.4168 55.453 88.0063 55.7463L89.75 58.1875L91.4937 60.6287C92.2498 60.0886 92.9711 59.4423 93.5202 58.6579L91.0625 56.9375ZM89.75 58.1875L88.0063 55.7463C87.6752 55.9828 87.2339 56.22 86.6504 56.435L87.6875 59.25L88.7246 62.065C89.7244 61.6967 90.6582 61.2255 91.4937 60.6287L89.75 58.1875ZM87.6875 59.25L86.5233 56.4851C85.9815 56.7132 85.3164 56.9059 84.5068 57.0408L85 60L85.4932 62.9592C86.6836 62.7608 87.8102 62.4534 88.8517 62.0149L87.6875 59.25ZM85 60L84.3627 57.0685C83.6263 57.2286 82.8406 57.3125 82 57.3125V60.3125V63.3125C83.2427 63.3125 84.457 63.1881 85.6373 62.9315L85 60ZM82 60.3125V57.3125C80.8612 57.3125 79.7059 57.1343 78.5245 56.763L77.625 59.625L76.7255 62.487C78.4608 63.0324 80.2221 63.3125 82 63.3125V60.3125ZM77.625 59.625L78.5245 56.763C77.5091 56.4439 76.5828 55.9071 75.7289 55.1141L73.6875 57.3125L71.6461 59.5109C73.1255 60.8846 74.8242 61.8894 76.7255 62.487L77.625 59.625ZM73.6875 57.3125L75.7289 55.1141C74.952 54.3928 74.2426 53.3584 73.6649 51.897L70.875 53L68.0851 54.103C68.924 56.225 70.0897 58.0656 71.6461 59.5109L73.6875 57.3125ZM70.875 53L73.6734 51.9188C73.1383 50.5339 72.8125 48.6562 72.8125 46.1875H69.8125H66.8125C66.8125 49.1354 67.195 51.7995 68.0766 54.0812L70.875 53ZM73.4375 46.3125L73.7628 49.2948L87.5128 47.7948L87.1875 44.8125L86.8622 41.8302L73.1122 43.3302L73.4375 46.3125ZM87.1875 44.8125H90.1875C90.1875 42.2295 89.4907 39.8249 87.7962 37.9349L85.5625 39.9375L83.3288 41.9401C83.8009 42.4668 84.1875 43.3122 84.1875 44.8125H87.1875ZM85.5625 39.9375L87.8296 37.9727C85.9539 35.8085 83.1894 35.0625 80.3125 35.0625V38.0625V41.0625C82.2689 41.0625 83.0044 41.5665 83.2954 41.9023L85.5625 39.9375ZM80.3125 38.0625L80.2054 35.0644C78.6712 35.1192 77.1964 35.4539 75.858 36.155L77.25 38.8125L78.642 41.47C79.0536 41.2544 79.6205 41.0891 80.4196 41.0606L80.3125 38.0625ZM77.25 38.8125L75.8042 36.1839C74.6502 36.8186 73.643 37.6429 72.8092 38.6554L75.125 40.5625L77.4408 42.4696C77.7736 42.0654 78.1832 41.7231 78.6958 41.4411L77.25 38.8125ZM75.125 40.5625L72.8673 38.587C72.0108 39.5658 71.3788 40.6892 70.9665 41.9263L73.8125 42.875L76.6585 43.8237C76.8295 43.3108 77.0725 42.8925 77.3827 42.538L75.125 40.5625ZM73.8125 42.875L70.9665 41.9263C70.5735 43.1053 70.375 44.3214 70.375 45.5625H73.375H76.375C76.375 44.9703 76.4682 44.3947 76.6585 43.8237L73.8125 42.875ZM73.375 45.5625H70.375C70.375 45.9572 70.3936 46.5063 70.5271 47.0401L73.4375 46.3125L76.3479 45.5849C76.3569 45.6207 76.3633 45.6506 76.3677 45.6735C76.3722 45.6965 76.3751 45.7145 76.377 45.7269C76.3788 45.7393 76.3798 45.7475 76.3802 45.7511C76.3806 45.7547 76.3806 45.7548 76.3803 45.7509C76.3796 45.7425 76.3782 45.7227 76.377 45.6898C76.3758 45.6571 76.375 45.615 76.375 45.5625H73.375ZM117.312 44.1875H120.312V44.1237L120.31 44.06L117.312 44.1875ZM113.562 55.25L115.544 57.5021L115.55 57.497L113.562 55.25ZM110.062 57.1875L109.226 54.3065L110.062 57.1875ZM102.625 57.25L101.773 60.1264L101.787 60.1306L101.801 60.1346L102.625 57.25ZM100.062 56.0625L101.916 53.7035L96.8337 49.7104L97.0644 56.1696L100.062 56.0625ZM100.562 70.0625L100.851 73.0486L103.661 72.7766L103.561 69.9554L100.562 70.0625ZM96.6875 70.4375H93.6875V73.7418L96.9765 73.4236L96.6875 70.4375ZM96.6875 36.4375L93.7127 36.0495L93.6875 36.2427V36.4375H96.6875ZM97.0625 33.5625L96.3908 30.6387L94.3575 31.1058L94.0877 33.1745L97.0625 33.5625ZM113.938 35.4375L111.861 37.6025L111.883 37.6242L111.906 37.6453L113.938 35.4375ZM99.4375 37.9375L97.7734 35.4413L96.4049 36.3537L96.4381 37.9981L99.4375 37.9375ZM99.6875 50.3125L96.6881 50.3731L96.6935 50.6395L96.7458 50.9008L99.6875 50.3125ZM100.312 51.0625L98.4707 53.4306L98.5303 53.4769L98.5921 53.5202L100.312 51.0625ZM101.875 51.9375L100.606 54.656L100.712 54.7055L100.822 54.7465L101.875 51.9375ZM104.062 52.625L103.299 55.5262L103.371 55.5452L103.444 55.5606L104.062 52.625ZM108.875 52.5L109.778 55.3607L109.822 55.3468L109.866 55.3316L108.875 52.5ZM111.062 51.0625L108.941 48.9412L108.907 48.9754L108.874 49.0107L111.062 51.0625ZM112.562 40.8125L109.835 42.0625L109.867 42.1322L109.903 42.2002L112.562 40.8125ZM110.625 38.375L108.693 40.6697L108.757 40.7242L108.825 40.775L110.625 38.375ZM107.875 36.9375L106.926 39.7835L106.996 39.8067L107.066 39.8264L107.875 36.9375ZM117.312 44.1875H114.312V45.5H117.312H120.312V44.1875H117.312ZM117.312 45.5H114.312C114.312 47.5994 113.996 49.129 113.512 50.2124L116.25 51.4375L118.988 52.6626C119.92 50.5794 120.312 48.1506 120.312 45.5H117.312ZM116.25 51.4375L113.512 50.2124C112.944 51.482 112.281 52.3786 111.575 53.003L113.562 55.25L115.55 57.497C117.011 56.2047 118.14 54.5597 118.988 52.6626L116.25 51.4375ZM113.562 55.25L111.581 52.9979C110.859 53.6328 110.081 54.0583 109.226 54.3065L110.062 57.1875L110.899 60.0685C112.628 59.5667 114.183 58.7006 115.544 57.5021L113.562 55.25ZM110.062 57.1875L109.226 54.3065C108.166 54.6143 107.219 54.75 106.375 54.75V57.75V60.75C107.864 60.75 109.376 60.5107 110.899 60.0685L110.062 57.1875ZM106.375 57.75V54.75C105.293 54.75 104.323 54.615 103.449 54.3654L102.625 57.25L101.801 60.1346C103.261 60.5516 104.79 60.75 106.375 60.75V57.75ZM102.625 57.25L103.477 54.3736C102.529 54.0925 102.079 53.8316 101.916 53.7035L100.062 56.0625L98.209 58.4215C99.2127 59.2101 100.471 59.7408 101.773 60.1264L102.625 57.25ZM100.062 56.0625L97.0644 56.1696L97.5644 70.1696L100.562 70.0625L103.561 69.9554L103.061 55.9554L100.062 56.0625ZM100.562 70.0625L100.274 67.0764L96.3985 67.4514L96.6875 70.4375L96.9765 73.4236L100.851 73.0486L100.562 70.0625ZM96.6875 70.4375H99.6875V36.4375H96.6875H93.6875V70.4375H96.6875ZM96.6875 36.4375L99.6623 36.8255L100.037 33.9505L97.0625 33.5625L94.0877 33.1745L93.7127 36.0495L96.6875 36.4375ZM97.0625 33.5625L97.7342 36.4863C100.679 35.8099 103.109 35.5 105.062 35.5V32.5V29.5C102.516 29.5 99.6131 29.8984 96.3908 30.6387L97.0625 33.5625ZM105.062 32.5V35.5C108.454 35.5 110.557 36.3523 111.861 37.6025L113.938 35.4375L116.014 33.2725C113.234 30.6061 109.421 29.5 105.062 29.5V32.5ZM113.938 35.4375L111.906 37.6453C113.21 38.8444 114.169 40.8811 114.315 44.315L117.312 44.1875L120.31 44.06C120.123 39.6605 118.832 35.8639 115.969 33.2297L113.938 35.4375ZM99.4375 37.9375L96.4381 37.9981L96.6881 50.3731L99.6875 50.3125L102.687 50.2519L102.437 37.8769L99.4375 37.9375ZM99.6875 50.3125L96.7458 50.9008C96.9032 51.6881 97.3016 52.2543 97.5703 52.5768C97.8594 52.9237 98.1833 53.2071 98.4707 53.4306L100.312 51.0625L102.154 48.6944C102.067 48.6263 102.099 48.6388 102.18 48.7357C102.224 48.7884 102.302 48.8897 102.384 49.04C102.466 49.19 102.569 49.4208 102.629 49.7242L99.6875 50.3125ZM100.312 51.0625L98.5921 53.5202C99.1916 53.9398 99.8751 54.3148 100.606 54.656L101.875 51.9375L103.144 49.219C102.625 48.9769 102.267 48.7685 102.033 48.6048L100.312 51.0625ZM101.875 51.9375L100.822 54.7465C101.596 55.0369 102.423 55.2958 103.299 55.5262L104.062 52.625L104.826 49.7238C104.118 49.5375 103.487 49.3381 102.928 49.1285L101.875 51.9375ZM104.062 52.625L103.444 55.5606C104.445 55.7714 105.465 55.875 106.5 55.875V52.875V49.875C105.868 49.875 105.263 49.812 104.681 49.6894L104.062 52.625ZM106.5 52.875V55.875C107.613 55.875 108.709 55.6985 109.778 55.3607L108.875 52.5L107.972 49.6393C107.458 49.8015 106.971 49.875 106.5 49.875V52.875ZM108.875 52.5L109.866 55.3316C111.172 54.8746 112.308 54.1208 113.251 53.1143L111.062 51.0625L108.874 49.0107C108.567 49.3375 108.245 49.5421 107.884 49.6684L108.875 52.5ZM111.062 51.0625L113.184 53.1838C114.228 52.1401 114.973 50.8407 115.501 49.4169L112.688 48.375L109.874 47.3331C109.568 48.1593 109.231 48.6516 108.941 48.9412L111.062 51.0625ZM112.688 48.375L115.501 49.4169C116.079 47.8563 116.312 46.0815 116.312 44.1875H113.312H110.312C110.312 45.6268 110.13 46.6437 109.874 47.3331L112.688 48.375ZM113.312 44.1875H116.312C116.312 42.5063 115.985 40.8875 115.222 39.4248L112.562 40.8125L109.903 42.2002C110.14 42.6541 110.312 43.2854 110.312 44.1875H113.312ZM112.562 40.8125L115.29 39.5625C114.635 38.1342 113.681 36.917 112.425 35.975L110.625 38.375L108.825 40.775C109.236 41.083 109.573 41.4908 109.835 42.0625L112.562 40.8125ZM110.625 38.375L112.557 36.0803C111.423 35.1251 110.119 34.4505 108.684 34.0486L107.875 36.9375L107.066 39.8264C107.714 40.0079 108.244 40.2916 108.693 40.6697L110.625 38.375ZM107.875 36.9375L108.824 34.0915C107.509 33.6533 106.147 33.4375 104.75 33.4375V36.4375V39.4375C105.52 39.4375 106.241 39.555 106.926 39.7835L107.875 36.9375ZM104.75 36.4375V33.4375C103.527 33.4375 102.324 33.5974 101.148 33.9182L101.938 36.8125L102.727 39.7068C103.384 39.5276 104.056 39.4375 104.75 39.4375V36.4375ZM101.938 36.8125L101.148 33.9182C99.9373 34.2484 98.8059 34.753 97.7734 35.4413L99.4375 37.9375L101.102 40.4337C101.569 40.122 102.104 39.8766 102.727 39.7068L101.938 36.8125Z" fill="white" mask="url(#path-1-outside-1_122_28)"/>
                </g>
                <g filter="url(#filter1_d_122_28)">
                <path d="M45 30L59.2914 27L66.7886 30L74.0514 27L86 30" stroke="white" stroke-width="3" stroke-linecap="round"/>
                </g>
                <g filter="url(#filter2_d_122_28)">
                <path d="M37 24L56.52 16L66.76 24L76.68 16L93 24" stroke="white" stroke-width="3" stroke-linecap="round"/>
                </g>
                <defs>
                <filter id="filter0_d_122_28" x="6.8875" y="14.9375" width="115.225" height="64.6042" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
                <feFlood flood-opacity="0" result="BackgroundImageFix"/>
                <feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
                <feOffset dy="4"/>
                <feGaussianBlur stdDeviation="0.9"/>
                <feComposite in2="hardAlpha" operator="out"/>
                <feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.25 0"/>
                <feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_122_28"/>
                <feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_122_28" result="shape"/>
                </filter>
                <filter id="filter1_d_122_28" x="42.0997" y="25.0248" width="46.8007" height="8.99434" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
                <feFlood flood-opacity="0" result="BackgroundImageFix"/>
                <feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
                <feOffset dy="1"/>
                <feGaussianBlur stdDeviation="0.7"/>
                <feComposite in2="hardAlpha" operator="out"/>
                <feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.25 0"/>
                <feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_122_28"/>
                <feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_122_28" result="shape"/>
                </filter>
                <filter id="filter2_d_122_28" x="34.0996" y="13.8324" width="61.8007" height="14.4826" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
                <feFlood flood-opacity="0" result="BackgroundImageFix"/>
                <feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
                <feOffset dy="1"/>
                <feGaussianBlur stdDeviation="0.7"/>
                <feComposite in2="hardAlpha" operator="out"/>
                <feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.25 0"/>
                <feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_122_28"/>
                <feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_122_28" result="shape"/>
                </filter>
                </defs>
            </svg>

            <!-- <h1 class="logo">BipLogo</h1> -->
        </div>
        <div class="nav-center">
            <button class="nav-btn" id="bipersBtn">Beepers</button>
            <button class="nav-btn" id="talkBtn">Talk</button>
            <button class="nav-btn" id="listenBtn">Listen</button>
            <?php if ($user['isAdmin']): ?>
                <a href="admin.php" class="nav-btn">Admin</a>
            <?php endif; ?>
        </div>
        <div class="nav-right">
            <a href="settings.php" class="profile-link" title="Settings">
                <div class="profile-circle-nav" style="background-color: <?= e($user['profileColor']) ?>"></div>
            </a>
            <a href="../../authentication/logout.php" class="logout-btn" title="Logout">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
            </a>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="app-container">
        <!-- Left Sidebar: Conversations -->
        <aside class="conversations-sidebar">
            <div class="search-container">
                <input type="text" 
                       id="conversationSearch" 
                       placeholder="Search in conversation..." 
                       <?= $hasFreshExperience ? 'disabled' : '' ?>>
            </div>
            
            <div class="conversations-list" id="conversationsList">
                <?php if ($hasFreshExperience): ?>
                    <div class="no-conversations">
                        <p>No conversations yet</p>
                        <p>Click "Talk" or "Listen" to get started!</p>
                    </div>
                <?php else: ?>
                    <?php foreach ($conversations as $conv): ?>
                        <div class="conversation-item <?= $selectedConversationID == $conv['conversationID'] ? 'active' : '' ?>" 
                             data-conversation-id="<?= $conv['conversationID'] ?>">
                            <div class="conv-avatar-wrapper">
                                <div class="conv-avatar" style="background-color: <?= e($conv['interlocutorColor']) ?>"></div>
                                <span class="status-dot" style="background-color: <?= getStatusColor($conv['interlocutorMode'], $conv['interlocutorOnline'] && isUserOnline($conv['interlocutorLastSeen'])) ?>"></span>
                            </div>
                            <div class="conv-info">
                                <div class="conv-username">
                                    <?= e($conv['interlocutorUsername']) ?>
                                    <?php if ($conv['isInSafelist']): ?>
                                        <span class="safelist-star">â˜…</span>
                                    <?php endif; ?>
                                </div>
                                <div class="conv-time"><?= $conv['lastMessageTime'] ? timeAgo($conv['lastMessageTime']) : 'Just started' ?></div>
                            </div>
                        </div>
                    <?php endforeach; ?>
                <?php endif; ?>
            </div>
        </aside>

        <!-- Right Panel: Messages -->
        <main class="messages-panel">
            <?php if (!$selectedConversation): ?>
                <div class="no-conversation-selected">
                    <div class="welcome-message">
                        <h2>Welcome to Beep!</h2>
                        <p>Select a conversation from the left to start chatting</p>
                        <p>Or click "Talk" to find a listener</p>
                    </div>
                </div>
            <?php else: ?>
                <!-- Conversation Header -->
                <div class="conversation-header">
                    <div class="header-user-info" id="interlocutorProfile">
                        <div class="header-avatar-wrapper">
                            <div class="header-avatar" style="background-color: <?= e($selectedConversation['profileColor']) ?>"></div>
                            <span class="status-dot" style="background-color: <?= getStatusColor($selectedConversation['mode'], $selectedConversation['isOnline'] && isUserOnline($selectedConversation['lastSeenAt'])) ?>"></span>
                        </div>
                        <div class="header-info">
                            <div class="header-username"><?= e($selectedConversation['username']) ?></div>
                            <div class="header-status" id="interlocutorStatus">
                                <?= getStatusText($selectedConversation['mode'], $selectedConversation['isOnline'] && isUserOnline($selectedConversation['lastSeenAt'])) ?>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Messages Area -->
                <div class="messages-area" id="messagesArea">
                    <?php foreach ($messages as $msg): ?>
                        <?php if ($msg['isSystem']): ?>
                            <div class="message-system">
                                <?= e($msg['content']) ?>
                            </div>
                        <?php else: ?>
                            <?php $isOwn = $msg['senderUserID'] == $user['userID']; ?>
                            <div class="message <?= $isOwn ? 'message-own' : 'message-other' ?>" 
                                 data-message-id="<?= $msg['messageID'] ?>">
                                <div class="message-avatar">
                                    <div class="message-avatar-circle" style="background-color: <?= e($msg['senderColor']) ?>"></div>
                                </div>
                                <div class="message-content">
                                    <div class="message-bubble <?= $msg['isFlagged'] ? 'message-flagged' : '' ?>">
                                        <?= nl2br(e($msg['content'])) ?>
                                    </div>
                                    <div class="message-time"><?= date('g:i A', strtotime($msg['createdAt'])) ?></div>
                                </div>
                                <?php if (!$isOwn): ?>
                                    <button class="message-report-btn" title="Report this message" data-message-id="<?= $msg['messageID'] ?>">âš </button>
                                <?php endif; ?>
                            </div>
                        <?php endif; ?>
                    <?php endforeach; ?>
                </div>

                <!-- Message Input -->
                <div class="message-input-container">
                    <form id="messageForm">
                        <input type="hidden" name="conversationID" value="<?= $selectedConversationID ?>">
                        <textarea id="messageInput" 
                                  placeholder="Type Your Message Here..." 
                                  rows="1"></textarea>
                        <button type="submit" class="send-btn">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                            </svg>
                        </button>
                    </form>
                </div>
            <?php endif; ?>
        </main>
    </div>

    <!-- Report Modal -->
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h2>Report Message</h2>
            <form id="reportForm">
                <input type="hidden" id="reportMessageID" name="messageID">
                <div class="form-group">
                    <label>Reason for reporting:</label>
                    <select name="flagType" required>
                        <option value="">Select a reason</option>
                        <option value="INSULTING">Insulting</option>
                        <option value="SEXUAL">Sexual content</option>
                        <option value="THREATENING">Threatening</option>
                        <option value="DISCRIMINATORY">Discriminatory</option>
                        <option value="SPAM">Spam</option>
                        <option value="OTHER">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Additional details (optional):</label>
                    <textarea name="reason" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Submit Report</button>
            </form>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h2>User Profile</h2>
            <div class="profile-modal-content">
                <?php if ($selectedConversation): ?>
                    <div class="profile-circle-large" style="background-color: <?= e($selectedConversation['profileColor']) ?>"></div>
                    <h3><?= e($selectedConversation['username']) ?></h3>
                    
                    <div class="profile-rating">
                        <h4>Rate this user:</h4>
                        <div class="star-rating" id="starRating">
                            <span class="star" data-value="1">â˜†</span>
                            <span class="star" data-value="2">â˜†</span>
                            <span class="star" data-value="3">â˜†</span>
                            <span class="star" data-value="4">â˜†</span>
                            <span class="star" data-value="5">â˜†</span>
                        </div>
                    </div>
                    
                    <div class="profile-flags">
                        <h4>Flag this user:</h4>
                        <div class="flag-buttons">
                            <button class="btn btn-flag btn-flag-positive" data-flag="HELPFUL">Helpful</button>
                            <button class="btn btn-flag btn-flag-positive" data-flag="SAFE">Safe</button>
                            <button class="btn btn-flag btn-flag-positive" data-flag="EMPATHETIC">Empathetic</button>
                            <button class="btn btn-flag btn-flag-negative" data-flag="TOXIC">Toxic</button>
                            <button class="btn btn-flag btn-flag-negative" data-flag="DISRESPECTFUL">Disrespectful</button>
                        </div>
                    </div>
                    
                    <?php if ($selectedConversation['isInSafelist']): ?>
                        <p class="safelist-info">â˜… This user is in your safelist</p>
                    <?php endif; ?>
                <?php endif; ?>
            </div>
        </div>
    </div>

    <script>
        <?php if ($selectedConversationID && $selectedConversation): ?>
        const conversationID = <?= $selectedConversationID ?>;
        const interlocutorID = <?= $selectedConversation['userID'] ?>;
        const currentUserID = <?= $user['userID'] ?>;
        <?php else: ?>
        const conversationID = null;
        const interlocutorID = null;
        const currentUserID = <?= $user['userID'] ?>;
        <?php endif; ?>
    </script>
    <script src="../js/flags-loader.js"></script>
    <script src="../js/app.js"></script>
</body>
</html>
